<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rule Gallery - Shape Browser</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0a0a0a;
      color: #a0a0a0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      min-height: 100vh;
      padding: 1.5rem;
    }
    h1 { color: #4a7a4a; font-size: 1.1rem; letter-spacing: 0.15em; margin-bottom: 0.3rem; }
    .subtitle { color: #555; font-size: 0.75rem; margin-bottom: 1.5rem; }
    .container { max-width: 1600px; margin: 0 auto; }

    .controls {
      background: #111;
      border: 1px solid #222;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .control-group { display: flex; align-items: center; gap: 0.5rem; }
    .control-group label { font-size: 0.7rem; color: #555; }
    .control-group select, .control-group input {
      background: #0d0d0d; border: 1px solid #222; color: #888;
      padding: 0.4rem; font-family: inherit; font-size: 0.75rem;
    }
    button {
      background: #1a1a1a; border: 1px solid #333; color: #888;
      padding: 0.4rem 0.8rem; font-family: inherit; font-size: 0.75rem;
      cursor: pointer; border-radius: 3px;
    }
    button:hover { background: #222; color: #aaa; }
    button.primary { background: #1a2a1a; border-color: #2a4a2a; color: #6a9a6a; }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    .gallery-item {
      background: #111;
      border: 1px solid #222;
      border-radius: 3px;
      padding: 0.5rem;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .gallery-item:hover { border-color: #4a7a4a; }
    .gallery-item.selected { border-color: #6a9a6a; border-width: 2px; }
    .gallery-item canvas {
      width: 100%;
      aspect-ratio: 1;
      image-rendering: pixelated;
      background: #050505;
      display: block;
    }
    .gallery-item .label {
      font-size: 0.6rem;
      color: #555;
      margin-top: 0.3rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .detail-panel {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 300px;
      background: #111;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 1rem;
      display: none;
    }
    .detail-panel.visible { display: block; }
    .detail-panel h2 {
      font-size: 1rem;
      color: #7a9a7a;
      margin-bottom: 0.75rem;
    }
    .detail-canvas {
      width: 100%;
      aspect-ratio: 1;
      image-rendering: pixelated;
      background: #050505;
      border: 1px solid #222;
      margin-bottom: 0.75rem;
    }
    .detail-metrics {
      font-size: 0.75rem;
      line-height: 1.8;
    }
    .metric-row {
      display: flex;
      justify-content: space-between;
    }
    .metric-label { color: #555; }
    .metric-value { color: #888; }
    .detail-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .tag-input {
      flex: 1;
      background: #0d0d0d;
      border: 1px solid #222;
      color: #888;
      padding: 0.4rem;
      font-family: inherit;
      font-size: 0.75rem;
    }

    .stats-bar {
      font-size: 0.75rem;
      color: #555;
      margin-bottom: 1rem;
    }

    .pagination {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RULE GALLERY</h1>
    <p class="subtitle">Browse and label rule shapes</p>

    <div class="controls">
      <input type="file" id="file-input" accept=".csv" style="font-size: 0.75rem;">
      <button id="btn-load-storage" class="primary">Load from localStorage</button>
      <div class="control-group">
        <label>Sort by:</label>
        <select id="sort-by">
          <option value="rule_id">Rule ID</option>
          <option value="lambda">λ (Lambda)</option>
          <option value="D">D (Dimension)</option>
          <option value="gamma">γ (Gamma)</option>
          <option value="cluster_count">Clusters</option>
          <option value="edge_ratio">Edge Ratio</option>
          <option value="density_variance">Density Var</option>
        </select>
      </div>
      <div class="control-group">
        <label>Filter:</label>
        <select id="filter-class">
          <option value="all">All</option>
          <option value="aperiodic">Aperiodic</option>
          <option value="periodic">Periodic</option>
          <option value="fixed">Fixed</option>
        </select>
      </div>
      <div class="control-group">
        <label>D range:</label>
        <input type="number" id="filter-d-min" value="0" step="0.1" style="width:50px">
        <span>-</span>
        <input type="number" id="filter-d-max" value="2" step="0.1" style="width:50px">
      </div>
      <button id="btn-apply">Apply</button>
      <button id="btn-export-tags">Export Tags</button>
    </div>

    <div class="stats-bar" id="stats-bar">Load data to view gallery</div>

    <div class="gallery" id="gallery"></div>

    <div class="pagination" id="pagination"></div>
  </div>

  <div class="detail-panel" id="detail-panel">
    <h2 id="detail-title">--</h2>
    <canvas id="detail-canvas" class="detail-canvas" width="128" height="128"></canvas>
    <div class="detail-metrics">
      <div class="metric-row"><span class="metric-label">Rule ID:</span><span class="metric-value" id="detail-id">--</span></div>
      <div class="metric-row"><span class="metric-label">λ:</span><span class="metric-value" id="detail-lambda">--</span></div>
      <div class="metric-row"><span class="metric-label">D:</span><span class="metric-value" id="detail-d">--</span></div>
      <div class="metric-row"><span class="metric-label">γ:</span><span class="metric-value" id="detail-gamma">--</span></div>
      <div class="metric-row"><span class="metric-label">Class:</span><span class="metric-value" id="detail-class">--</span></div>
      <div class="metric-row"><span class="metric-label">Clusters:</span><span class="metric-value" id="detail-clusters">--</span></div>
      <div class="metric-row"><span class="metric-label">Edge Ratio:</span><span class="metric-value" id="detail-edge">--</span></div>
      <div class="metric-row"><span class="metric-label">Density Var:</span><span class="metric-value" id="detail-densvar">--</span></div>
    </div>
    <div class="detail-actions">
      <input type="text" class="tag-input" id="tag-input" placeholder="Add tag (e.g. blobs, maze, stripes)">
      <button id="btn-add-tag">Tag</button>
    </div>
    <div id="current-tags" style="margin-top: 0.5rem; font-size: 0.7rem; color: #6a9a6a;"></div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let tags = {}; // rule_id -> [tags]
    let selectedRule = null;
    let currentPage = 0;
    const perPage = 100;

    // Load tags from localStorage
    try {
      tags = JSON.parse(localStorage.getItem('rule_tags') || '{}');
    } catch(e) {}

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].match(/(".*?"|[^,]+)/g) || [];
        const row = {};
        headers.forEach((h, j) => {
          let v = (values[j] || '').replace(/^"|"$/g, '');
          row[h] = isNaN(v) || v === '' ? v : parseFloat(v);
        });
        if (row.thumbnail) data.push(row);
      }
      return data;
    }

    function thumbnailToArray(base64) {
      try {
        const binary = atob(base64);
        const bits = [];
        for (let i = 0; i < binary.length; i++) {
          const byte = binary.charCodeAt(i);
          for (let j = 0; j < 8; j++) {
            bits.push((byte >> j) & 1);
          }
        }
        return bits;
      } catch(e) {
        return null;
      }
    }

    function drawThumbnail(canvas, base64, size = 32) {
      const ctx = canvas.getContext('2d');
      const bits = thumbnailToArray(base64);

      ctx.fillStyle = '#050505';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (!bits) return;

      const cellSize = canvas.width / size;
      ctx.fillStyle = '#4a7a4a';

      for (let i = 0; i < bits.length; i++) {
        if (bits[i]) {
          const r = Math.floor(i / size);
          const c = i % size;
          ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
        }
      }
    }

    function applyFilters() {
      const sortBy = document.getElementById('sort-by').value;
      const filterClass = document.getElementById('filter-class').value;
      const dMin = parseFloat(document.getElementById('filter-d-min').value);
      const dMax = parseFloat(document.getElementById('filter-d-max').value);

      filteredData = allData.filter(r => {
        if (filterClass !== 'all' && r.classification !== filterClass) return false;
        if (r.D < dMin || r.D > dMax) return false;
        return true;
      });

      filteredData.sort((a, b) => {
        const va = a[sortBy] ?? 0;
        const vb = b[sortBy] ?? 0;
        return va - vb;
      });

      currentPage = 0;
      renderGallery();
    }

    function renderGallery() {
      const gallery = document.getElementById('gallery');
      const start = currentPage * perPage;
      const end = Math.min(start + perPage, filteredData.length);
      const pageData = filteredData.slice(start, end);

      document.getElementById('stats-bar').textContent =
        `Showing ${start + 1}-${end} of ${filteredData.length} rules (${allData.length} total loaded)`;

      gallery.innerHTML = '';

      for (const rule of pageData) {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        if (selectedRule && selectedRule.rule_id === rule.rule_id) {
          item.classList.add('selected');
        }

        const canvas = document.createElement('canvas');
        canvas.width = 64;
        canvas.height = 64;
        drawThumbnail(canvas, rule.thumbnail);

        const label = document.createElement('div');
        label.className = 'label';
        const ruleTags = tags[rule.rule_id];
        label.textContent = ruleTags ? `${rule.rule_string} [${ruleTags.join(',')}]` : rule.rule_string;

        item.appendChild(canvas);
        item.appendChild(label);
        item.addEventListener('click', () => selectRule(rule));

        gallery.appendChild(item);
      }

      renderPagination();
    }

    function renderPagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredData.length / perPage);

      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      const addBtn = (text, page) => {
        const btn = document.createElement('button');
        btn.textContent = text;
        if (page === currentPage) btn.style.background = '#2a4a2a';
        btn.addEventListener('click', () => {
          currentPage = page;
          renderGallery();
        });
        pagination.appendChild(btn);
      };

      addBtn('«', 0);
      addBtn('‹', Math.max(0, currentPage - 1));

      const startPage = Math.max(0, currentPage - 2);
      const endPage = Math.min(totalPages - 1, currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        addBtn(i + 1, i);
      }

      addBtn('›', Math.min(totalPages - 1, currentPage + 1));
      addBtn('»', totalPages - 1);
    }

    function selectRule(rule) {
      selectedRule = rule;
      const panel = document.getElementById('detail-panel');
      panel.classList.add('visible');

      document.getElementById('detail-title').textContent = rule.rule_string;
      document.getElementById('detail-id').textContent = rule.rule_id;
      document.getElementById('detail-lambda').textContent = rule.lambda > -10 ? rule.lambda.toFixed(4) : 'healed';
      document.getElementById('detail-d').textContent = rule.D.toFixed(4);
      document.getElementById('detail-gamma').textContent = rule.gamma.toFixed(2);
      document.getElementById('detail-class').textContent = rule.classification;
      document.getElementById('detail-clusters').textContent = rule.cluster_count || '--';
      document.getElementById('detail-edge').textContent = rule.edge_ratio ? rule.edge_ratio.toFixed(4) : '--';
      document.getElementById('detail-densvar').textContent = rule.density_variance ? rule.density_variance.toFixed(6) : '--';

      const canvas = document.getElementById('detail-canvas');
      drawThumbnail(canvas, rule.thumbnail, 32);

      // Show current tags
      const ruleTags = tags[rule.rule_id] || [];
      document.getElementById('current-tags').textContent = ruleTags.length > 0 ? 'Tags: ' + ruleTags.join(', ') : '';

      renderGallery(); // Update selection highlight
    }

    function addTag() {
      if (!selectedRule) return;
      const input = document.getElementById('tag-input');
      const tag = input.value.trim().toLowerCase();
      if (!tag) return;

      if (!tags[selectedRule.rule_id]) {
        tags[selectedRule.rule_id] = [];
      }
      if (!tags[selectedRule.rule_id].includes(tag)) {
        tags[selectedRule.rule_id].push(tag);
      }

      localStorage.setItem('rule_tags', JSON.stringify(tags));
      input.value = '';

      // Update display
      document.getElementById('current-tags').textContent = 'Tags: ' + tags[selectedRule.rule_id].join(', ');
      renderGallery();
    }

    function exportTags() {
      const lines = ['rule_id,rule_string,tags'];
      for (const [ruleId, ruleTags] of Object.entries(tags)) {
        const rule = allData.find(r => r.rule_id == ruleId);
        if (rule && ruleTags.length > 0) {
          lines.push(`${ruleId},"${rule.rule_string}","${ruleTags.join(';')}"`);
        }
      }
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rule-tags.csv';
      a.click();
    }

    // Event handlers
    document.getElementById('file-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        allData = parseCSV(ev.target.result);
        applyFilters();
      };
      reader.readAsText(file);
    });

    document.getElementById('btn-load-storage').addEventListener('click', () => {
      try {
        const stored = JSON.parse(localStorage.getItem('cells_survey_v3'));
        if (stored && stored.results) {
          allData = stored.results.filter(r => r.thumbnail);
          applyFilters();
        }
      } catch(e) {
        alert('Failed to load: ' + e.message);
      }
    });

    document.getElementById('btn-apply').addEventListener('click', applyFilters);
    document.getElementById('btn-add-tag').addEventListener('click', addTag);
    document.getElementById('tag-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addTag();
    });
    document.getElementById('btn-export-tags').addEventListener('click', exportTags);

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('detail-panel');
      const gallery = document.getElementById('gallery');
      if (!panel.contains(e.target) && !gallery.contains(e.target)) {
        panel.classList.remove('visible');
        selectedRule = null;
        renderGallery();
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Results Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #0a0a0a;
      color: #a0a0a0;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      min-height: 100vh;
    }
    .header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #1a1a1a;
    }
    h1 {
      color: #4a7a4a;
      font-size: 1rem;
      letter-spacing: 0.15em;
    }
    .subtitle {
      color: #555;
      font-size: 0.75rem;
      margin-top: 0.3rem;
    }
    .main {
      display: flex;
      height: calc(100vh - 80px);
    }
    .sidebar {
      width: 300px;
      border-right: 1px solid #1a1a1a;
      padding: 1rem;
      overflow-y: auto;
    }
    .content {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .panel {
      background: #111;
      border: 1px solid #222;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .panel-title {
      color: #666;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.75rem;
    }
    button {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 3px;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #222;
      color: #aaa;
    }
    button.active {
      background: #1a2a1a;
      border-color: #2a4a2a;
      color: #6a9a6a;
    }
    input[type="file"] {
      display: none;
    }
    .file-label {
      display: inline-block;
      background: #1a2a1a;
      border: 1px solid #2a4a2a;
      color: #6a9a6a;
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 3px;
    }
    .file-label:hover {
      background: #223a22;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
      border-bottom: 1px solid #1a1a1a;
      font-size: 0.75rem;
    }
    .stat-label {
      color: #555;
    }
    .stat-value {
      color: #888;
      font-variant-numeric: tabular-nums;
    }
    .viz-container {
      flex: 1;
      position: relative;
      background: #0d0d0d;
      border: 1px solid #1a1a1a;
      border-radius: 4px;
      overflow: hidden;
    }
    #viz-3d {
      width: 100%;
      height: 100%;
    }
    .heatmaps {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .heatmap-item {
      text-align: center;
    }
    .heatmap-item canvas {
      border: 1px solid #222;
      border-radius: 2px;
    }
    .heatmap-item .label {
      font-size: 0.7rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .top-rules {
      max-height: 400px;
      overflow-y: auto;
    }
    .rule-item {
      padding: 0.5rem;
      border-bottom: 1px solid #1a1a1a;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .rule-item:hover {
      background: #151515;
    }
    .rule-name {
      color: #7a9a7a;
      font-weight: bold;
    }
    .rule-metrics {
      color: #555;
      margin-top: 0.2rem;
    }
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.5rem 1rem;
      background: #111;
      border: 1px solid #222;
      color: #666;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .tab:first-child {
      border-radius: 4px 0 0 4px;
    }
    .tab:last-child {
      border-radius: 0 4px 4px 0;
    }
    .tab.active {
      background: #1a2a1a;
      border-color: #2a4a2a;
      color: #6a9a6a;
    }
    .hidden {
      display: none;
    }
    #drop-zone {
      border: 2px dashed #333;
      border-radius: 4px;
      padding: 2rem;
      text-align: center;
      color: #555;
      margin-bottom: 1rem;
    }
    #drop-zone.dragover {
      border-color: #4a7a4a;
      background: #111;
    }
    .legend {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.7rem;
      color: #666;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>SURVEY RESULTS VIEWER</h1>
    <p class="subtitle">Visualize and analyze the 262,144 rule survey data</p>
  </div>

  <div class="main">
    <div class="sidebar">
      <!-- Data Loading -->
      <div class="panel">
        <div class="panel-title">Load Data</div>
        <div id="drop-zone">
          Drop CSV file here<br>
          <small>or click to browse</small>
        </div>
        <input type="file" id="file-input" accept=".csv">
        <button id="load-checkpoint">Load from Checkpoint</button>
      </div>

      <!-- Statistics -->
      <div class="panel">
        <div class="panel-title">Statistics</div>
        <div id="stats-container">
          <p style="color: #555; font-size: 0.75rem;">No data loaded</p>
        </div>
      </div>

      <!-- Top Rules -->
      <div class="panel">
        <div class="panel-title">Top 20 Interesting Rules</div>
        <div class="top-rules" id="top-rules">
          <p style="color: #555; font-size: 0.75rem;">Load data to see top rules</p>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- View Tabs -->
      <div class="tabs">
        <div class="tab active" data-view="scatter">3D Scatter</div>
        <div class="tab" data-view="heatmaps">Heatmaps</div>
        <div class="tab" data-view="projections">2D Projections</div>
      </div>

      <!-- 3D Scatter View -->
      <div class="viz-container" id="view-scatter">
        <div id="viz-3d"></div>
        <div style="position: absolute; bottom: 10px; left: 10px;">
          <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background: #444"></div> Extinct</div>
            <div class="legend-item"><div class="legend-color" style="background: #4488aa"></div> Fixed</div>
            <div class="legend-item"><div class="legend-color" style="background: #aa8844"></div> Periodic</div>
            <div class="legend-item"><div class="legend-color" style="background: #44aa44"></div> Aperiodic</div>
          </div>
        </div>
      </div>

      <!-- Heatmaps View -->
      <div class="viz-container hidden" id="view-heatmaps" style="overflow: auto; padding: 1rem;">
        <div class="heatmaps" id="heatmaps-grid">
          <p style="color: #555; font-size: 0.75rem;">Load data to see heatmaps</p>
        </div>
      </div>

      <!-- 2D Projections View -->
      <div class="viz-container hidden" id="view-projections" style="overflow: auto; padding: 1rem;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
          <div class="heatmap-item">
            <canvas id="proj-lambda-d" width="300" height="300"></canvas>
            <div class="label">λ vs D</div>
          </div>
          <div class="heatmap-item">
            <canvas id="proj-lambda-gamma" width="300" height="300"></canvas>
            <div class="label">λ vs γ</div>
          </div>
          <div class="heatmap-item">
            <canvas id="proj-d-gamma" width="300" height="300"></canvas>
            <div class="label">D vs γ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createScatter3D, createScatter2D } from './src/viz/scatter3d.js';
    import { createHeatmap, createCombinedHeatmaps } from './src/viz/heatmap.js';

    let surveyData = [];
    let scatter3d = null;

    // DOM elements
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const statsContainer = document.getElementById('stats-container');
    const topRulesContainer = document.getElementById('top-rules');
    const heatmapsGrid = document.getElementById('heatmaps-grid');
    const viz3d = document.getElementById('viz-3d');

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const view = tab.dataset.view;
        document.getElementById('view-scatter').classList.toggle('hidden', view !== 'scatter');
        document.getElementById('view-heatmaps').classList.toggle('hidden', view !== 'heatmaps');
        document.getElementById('view-projections').classList.toggle('hidden', view !== 'projections');

        if (view === 'scatter' && surveyData.length > 0 && !scatter3d) {
          createVisualization();
        }
        if (view === 'projections' && surveyData.length > 0) {
          create2DProjections();
        }
      });
    });

    // File handling
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) loadCSV(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) loadCSV(file);
    });

    document.getElementById('load-checkpoint').addEventListener('click', () => {
      try {
        const checkpoint = localStorage.getItem('cells_survey_checkpoint');
        if (checkpoint) {
          const data = JSON.parse(checkpoint);
          if (data.results && data.results.length > 0) {
            surveyData = data.results;
            onDataLoaded();
          } else {
            alert('No results in checkpoint');
          }
        } else {
          alert('No checkpoint found');
        }
      } catch (error) {
        alert('Error loading checkpoint: ' + error.message);
      }
    });

    function loadCSV(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        surveyData = parseCSV(text);
        onDataLoaded();
      };
      reader.readAsText(file);
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        for (let j = 0; j < headers.length; j++) {
          let value = values[j]?.trim().replace(/"/g, '');
          // Convert numbers
          if (!isNaN(value) && value !== '') {
            value = parseFloat(value);
          }
          row[headers[j]] = value;
        }
        data.push(row);
      }

      return data;
    }

    function onDataLoaded() {
      console.log(`Loaded ${surveyData.length} rules`);
      updateStats();
      updateTopRules();
      createVisualization();
      createHeatmapVisualization();
    }

    function updateStats() {
      const validLambda = surveyData.filter(d => d.lambda > -10).map(d => d.lambda);
      const dims = surveyData.map(d => d.D);
      const gammas = surveyData.map(d => d.gamma);

      const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

      const classifications = {};
      for (const d of surveyData) {
        classifications[d.classification] = (classifications[d.classification] || 0) + 1;
      }

      statsContainer.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">Total Rules</span>
          <span class="stat-value">${surveyData.length.toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Mean λ</span>
          <span class="stat-value">${mean(validLambda).toFixed(4)}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Mean D</span>
          <span class="stat-value">${mean(dims).toFixed(4)}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Mean γ</span>
          <span class="stat-value">${mean(gammas).toFixed(2)}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Extinct</span>
          <span class="stat-value">${(classifications.extinct || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Fixed</span>
          <span class="stat-value">${(classifications.fixed || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Periodic</span>
          <span class="stat-value">${(classifications.periodic || 0).toLocaleString()}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Aperiodic</span>
          <span class="stat-value">${(classifications.aperiodic || 0).toLocaleString()}</span>
        </div>
      `;
    }

    function updateTopRules() {
      // Score rules by interestingness: high D, moderate λ, positive γ
      const scored = surveyData
        .filter(d => d.lambda > -10 && d.classification === 'aperiodic')
        .map(d => ({
          ...d,
          score: d.D * 10 - Math.abs(d.lambda) * 5 + Math.max(0, d.gamma) * 0.1
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 20);

      topRulesContainer.innerHTML = scored.map(d => `
        <div class="rule-item" data-rule="${d.rule_id}">
          <div class="rule-name">${d.rule_string}</div>
          <div class="rule-metrics">λ=${d.lambda.toFixed(3)} D=${d.D.toFixed(3)} γ=${d.gamma.toFixed(1)}</div>
        </div>
      `).join('');
    }

    function createVisualization() {
      if (scatter3d) {
        scatter3d.dispose();
      }

      viz3d.innerHTML = '';

      if (surveyData.length === 0) {
        viz3d.innerHTML = '<p style="color: #555; padding: 2rem;">Load data to visualize</p>';
        return;
      }

      scatter3d = createScatter3D(viz3d, surveyData, {
        pointSize: 1.5,
        showAxes: true,
        showLabels: true
      });
    }

    function createHeatmapVisualization() {
      if (surveyData.length === 0) {
        return;
      }

      const combined = createCombinedHeatmaps(surveyData, { size: 256 });

      heatmapsGrid.innerHTML = '';
      heatmapsGrid.appendChild(combined);

      // Add download button
      const btn = document.createElement('button');
      btn.textContent = 'Download Heatmaps';
      btn.style.marginTop = '1rem';
      btn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'rule-space-heatmaps.png';
        link.href = combined.toDataURL('image/png');
        link.click();
      });
      heatmapsGrid.appendChild(btn);
    }

    function create2DProjections() {
      if (surveyData.length === 0) return;

      createScatter2D(document.getElementById('proj-lambda-d'), surveyData, {
        xAxis: 'lambda',
        yAxis: 'D'
      });

      createScatter2D(document.getElementById('proj-lambda-gamma'), surveyData, {
        xAxis: 'lambda',
        yAxis: 'gamma'
      });

      createScatter2D(document.getElementById('proj-d-gamma'), surveyData, {
        xAxis: 'D',
        yAxis: 'gamma'
      });
    }
  </script>
</body>
</html>
